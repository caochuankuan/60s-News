name: Push 60s News To WeCom (Text)

on:
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch: {}

jobs:
  push_60s:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch 60s API with Retry
        id: get60s
        run: |
          max_retry=5
          retry=0
          json=""

          while [ $retry -lt $max_retry ]; do
            echo "Fetching API... try $((retry+1))"
            json=$(curl -s --connect-timeout 8 --max-time 15 "http://60api.09cdn.xyz/v2/60s")

            # æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆ JSON
            echo "$json" | jq empty >/dev/null 2>&1
            if [ $? -eq 0 ]; then
              echo "JSON valid"
              break
            else
              echo "JSON invalid, retrying..."
              sleep 2
            fi

            retry=$((retry+1))
          done

          if [ $retry -eq $max_retry ]; then
            echo "Failed to fetch valid JSON after $max_retry attempts"
            exit 1
          fi

          echo "json=$json" >> $GITHUB_OUTPUT

      - name: Send To WeCom Text
        run: |
          json='${{ steps.get60s.outputs.json }}'

          date=$(echo "$json" | jq -r '.data.date')
          tip=$(echo "$json" | jq -r '.data.tip')
          link=$(echo "$json" | jq -r '.data.link')
          news=$(echo "$json" | jq -r '.data.news[]')

          content="ðŸ“… æ—¥æœŸï¼š$date\n\nðŸ“° ä»Šæ—¥æ–°é—»ï¼š\n"

          while IFS= read -r line; do
            content="$content- $line\n"
          done <<< "$news"

          content="$content\nðŸ’¡ æ¯æ—¥ä¸€å¥ï¼š$tip\n\nè¯¦æƒ…ï¼š$link"

          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"msgtype\":\"text\",\"text\":{\"content\":\"$content\"}}" \
            "$WECHAT_WEBHOOK"

    env:
      WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
