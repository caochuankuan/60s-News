name: Push 60s News To WeCom

on:
  schedule:
    # æ¯å¤© 09:00 æ¨é€ä¸€æ¬¡ï¼ˆä½ å¯ä»¥æ”¹ï¼‰
    - cron: '0 1 * * *'  # UTC+0 01:00 = åŒ—äº¬æ—¶é—´ 09:00
  workflow_dispatch: {} # æ‰‹åŠ¨è§¦å‘

jobs:
  push_60s:
    runs-on: ubuntu-latest

    steps:
      - name: Call 60s API
        id: get60s
        run: |
          response=$(curl -s "https://60s.viki.moe/v2/60s")
          echo "$response"
          echo "json=$response" >> $GITHUB_OUTPUT

      - name: Send To WeCom Webhook
        run: |
          json='${{ steps.get60s.outputs.json }}'

          # æå–å­—æ®µ
          news=$(echo "$json" | jq -r '.data.news[]' | sed 's/^/- /')
          date=$(echo "$json" | jq -r '.data.date')
          tip=$(echo "$json" | jq -r '.data.tip')
          link=$(echo "$json" | jq -r '.data.link')

          content="ğŸ“… *$date*\n\nğŸ“° *60s News*\n$news\n\nğŸ’¡ *æ¯æ—¥ä¸€å¥*: $tip\n\nğŸ”— [è¯¦æƒ…æŸ¥çœ‹]($link)"

          echo -e "$content"

          # æ¨é€åˆ°ä¼ä¸šå¾®ä¿¡æœºå™¨äºº
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"msgtype\": \"markdown\", \"markdown\": {\"content\": \"$content\"}}" \
            "$WECHAT_WEBHOOK"

    env:
      WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
